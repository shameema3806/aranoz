<%- include("../../views/partials/admin/header") %>

<div class="min-h-screen flex items-center justify-center p-4">
  <div class="max-w-5xl w-full bg-white rounded-xl shadow-lg p-6 space-y-6 ml-8 md:ml-16 lg:ml-24">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b-2 border-[#1A5D8C]">
      <h1 class="text-[#154b70] text-2xl font-bold">Category</h1>

      <div class="flex items-center gap-3 w-full sm:w-auto">
        <form action="/admin/category" method="get" class="flex items-center bg-[#1A5D8C] rounded-md overflow-hidden flex-1 sm:flex-initial">
          <input 
            type="text" 
            name="search" 
            placeholder="Search categories..."
            value="<%= searchQuery || '' %>"
            class="w-full sm:w-64 px-3 py-2 bg-transparent text-white placeholder-white/70 outline-none text-sm"
          />
          <button type="submit" class="px-3 text-white">
            Search
          </button>
        </form>

        <% if (searchQuery) { %>
          <a href="/admin/category" class="text-[#1A5D8C] underline text-sm whitespace-nowrap">Clear</a>
        <% } %>

        <button 
          id="showAddCategoryPopup" 
          class="bg-[#1A5D8C] hover:bg-[#154b70] text-white font-medium px-4 py-2 rounded-md transition flex items-center gap-2 text-sm whitespace-nowrap">
          <i class="fas fa-plus"></i> Add
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="flex justify-center">
      <table id="categoryTable" class="w-full text-sm max-w-4xl pl-12 pr-4 md:pl-20 md:pr-8 lg:pl-32 lg:pr-12">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">S.No.</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Category</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Description</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Offer Price</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Offer</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Status</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Action</th>
            <th class="px-4 py-3 text-left font-medium text-[#1A5D8C]">Edit</th>
          </tr>
        </thead>
        <tbody id="categoryTableBody" class="divide-y divide-gray-200">
          <% cat.forEach((category, index) => { %>
            <tr class="hover:bg-gray-50 transition" data-id="<%= category._id %>">
              <td class="px-4 py-3"><%= (currentPage - 1) * itemsPerPage + index + 1 %></td>
              <td class="px-4 py-3 font-medium"><%= category.name %></td>
              <td class="px-4 py-3 text-gray-600"><%= category.description %></td>
              <td class="px-4 py-3">$50</td>
              <td class="px-4 py-3">10%</td>
              <td class="px-4 py-3">
                <span class="inline-block px-3 py-1 text-xs font-medium rounded-full <%= category.isListed ? 'bg-[#1A5D8C] text-white' : 'bg-red-600 text-white' %>">
                  <%= category.isListed ? 'Active' : 'Inactive' %>
                </span>
              </td>
              <td class="px-4 py-3">
                <a href="<%= category.isListed ? `/admin/ListCategory?id=${category._id}` : `/admin/unListCategory?id=${category._id}` %>"
                   class="inline-block px-3 py-1 text-xs font-medium text-white rounded-md <%= category.isListed ? 'bg-red-600 hover:bg-red-700' : 'bg-[#1A5D8C] hover:bg-[#154b70]' %> transition">
                  <%= category.isListed ? 'Unlist' : 'List' %>
                </a>
              </td>
<td class="px-4 py-3">
  <button class="inline-block px-3 py-1 text-xs font-medium text-white bg-[#1A5D8C] hover:bg-[#154b70] rounded-md transition"
          data-edit-category
          data-id="<%= category._id %>"
          data-name="<%= category.name %>"
          data-description="<%= category.description %>">
    Edit
  </button>
</td>

            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center items-center gap-1 py-3">
      <% if (totalPages > 1) { %>
        <% if (currentPage > 1) { %>
          <a href="?page=<%= currentPage - 1 %>" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-100">&lt;</a>
        <% } else { %>
          <span class="px-3 py-1.5 text-gray-400">&lt;</span>
        <% } %>

        <% for (let i = 1; i <= totalPages; i++) { %>
          <% if (i === currentPage) { %>
            <span class="px-3 py-1.5 bg-[#1A5D8C] text-white rounded text-sm"><%= i %></span>
          <% } else { %>
            <a href="?page=<%= i %>" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-100"><%= i %></a>
          <% } %>
        <% } %>

        <% if (currentPage < totalPages) { %>
          <a href="?page=<%= currentPage + 1 %>" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-100">&gt;</a>
        <% } else { %>
          <span class="px-3 py-1.5 text-gray-400">&gt;</span>
        <% } %>
      <% } %>
    </div>

    
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Add Category Popup with Validation
  document.getElementById('showAddCategoryPopup').addEventListener('click', () => {
    Swal.fire({
      title: 'Add New Category',
      html: `
        <div class="text-left">
          <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input id="swal-name" class="swal2-input" placeholder="Enter category name" autocomplete="off">
          <div id="swal-name-error" class="text-red-500 text-xs mt-1 min-h-[1.25rem]"></div>

          <label class="block text-sm font-medium text-gray-700 mb-1 mt-3">Description</label>
          <textarea id="swal-description" class="swal2-textarea" placeholder="Enter description"></textarea>
          <div id="swal-description-error" class="text-red-500 text-xs mt-1 min-h-[1.25rem]"></div>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'Create Category',
      cancelButtonText: 'Cancel',
      width: '32rem',
      customClass: {
        popup: 'rounded-xl',
        confirmButton: 'bg-[#1A5D8C] hover:bg-[#154b70] text-white px-5 py-2 rounded-md',
        cancelButton: 'bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded-md'
      },
      preConfirm: () => {
        const name = document.getElementById('swal-name').value.trim();
        const description = document.getElementById('swal-description').value.trim();

        // Reset errors
        document.getElementById('swal-name-error').textContent = '';
        document.getElementById('swal-description-error').textContent = '';

        let valid = true;

        // Name validation
        if (!name) {
          document.getElementById('swal-name-error').textContent = 'Please enter a category name';
          valid = false;
        } else if (!/^[a-zA-Z\s]+$/.test(name)) {
          document.getElementById('swal-name-error').textContent = 'Only letters and spaces allowed';
          valid = false;
        } else if (name.length < 2) {
          document.getElementById('swal-name-error').textContent = 'Name too short';
          valid = false;
        }

        // Description validation
        if (!description) {
          document.getElementById('swal-description-error').textContent = 'Please enter a description';
          valid = false;
        } else if (description.length < 10) {
          document.getElementById('swal-description-error').textContent = 'Description too short (min 10 chars)';
          valid = false;
        }

        if (!valid) return false;

        return { name, description };
      }
    }).then((result) => {
      if (result.isConfirmed) {
        const { name, description } = result.value;

        // Show loading
        Swal.fire({
          title: 'Adding...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        fetch("/admin/addCategory", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, description })
        })
        .then(async res => {
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to add category");

          // Success: Add to top of table
          const tbody = document.getElementById('categoryTableBody');
          const newRow = document.createElement('tr');
          newRow.className = 'hover:bg-gray-50 transition animate-fadeIn';
          newRow.dataset.id = data.category._id;

          newRow.innerHTML = `
            <td class="px-4 py-3">1</td>
            <td class="px-4 py-3 font-medium">${data.category.name}</td>
            <td class="px-4 py-3 text-gray-600">${data.category.description}</td>
            <td class="px-4 py-3">$50</td>
            <td class="px-4 py-3">10%</td>
            <td class="px-4 py-3">
              <span class="inline-block px-3 py-1 text-xs font-medium rounded-full bg-[#1A5D8C] text-white">Active</span>
            </td>
            <td class="px-4 py-3">
              <a href="/admin/ListCategory?id=${data.category._id}"
                 class="inline-block px-3 py-1 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition">
                Unlist
              </a>
            </td>
            <td class="px-4 py-3">
              <a href="/admin/editCategory?id=${data.category._id}"
                 class="inline-block px-3 py-1 text-xs font-medium text-white bg-[#1A5D8C] hover:bg-[#154b70] rounded-md transition">
                Edit
              </a>
            </td>
          `;
          //  EJS variable safely injected
          const itemsPerPage = Number(<%= itemsPerPage %>);

          // Insert new row at top
          tbody.insertBefore(newRow, tbody.firstChild);

          // If row count exceeds limit (e.g., 5 per page), remove the last one
          const rows = tbody.querySelectorAll('tr');
          if (rows.length > itemsPerPage) {
            tbody.removeChild(rows[rows.length - 1]);
          }

          // Recalculate S.No.
          tbody.querySelectorAll('tr').forEach((row, idx) => {
            row.querySelector('td:first-child').textContent = idx + 1;
          });

          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Category added at the top!',
            timer: 1500,
            showConfirmButton: false
          });
        })
        .catch(err => {
          Swal.fire('Error', err.message, 'error');
        });
      }
    });
  });
</script>

<script>
  // --------------------------------------------------------------
  //  EDIT CATEGORY – SweetAlert2 Popup
  // --------------------------------------------------------------
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-edit-category]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id          = btn.dataset.id;
        const currentName = btn.dataset.name;
        const currentDesc = btn.dataset.description || '';

        const { value: formValues } = await Swal.fire({
          title: '<strong>Update Category</strong>',
          html: `
            <div style="text-align:left;">
              <label class="swal2-label">Name</label>
              <input id="swal-name" class="swal2-input" value="${currentName}" placeholder="Category name">

              <label class="swal2-label" style="margin-top:12px;">Description</label>
              <textarea id="swal-desc" class="swal2-textarea" rows="4" placeholder="Description">${currentDesc}</textarea>
            </div>
          `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'Update Category',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#1A5D8C',
          preConfirm: () => {
            const name = document.getElementById('swal-name').value.trim();
            const desc = document.getElementById('swal-desc').value.trim();

            if (!name) {
              Swal.showValidationMessage('Please enter a category name');
              return false;
            }
            if (!desc) {
              Swal.showValidationMessage('Please enter a description');
              return false;
            }
            return { name, description: desc };
          }
        });

        // ------------------------------------------------------------
        //  USER CONFIRMED → POST to server
        // ------------------------------------------------------------
        if (formValues) {
          try {
            const res = await fetch(`/admin/editCategory/${id}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                categoryName: formValues.name,
                description: formValues.description
              })
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.error || 'Update failed');

            // ---- SUCCESS → refresh row (AJAX style) ----
            const $row = btn.closest('tr');
            $row.querySelector('td:nth-child(2)').textContent = formValues.name;
            $row.querySelector('td:nth-child(3)').textContent = formValues.description;

            Swal.fire({
              icon: 'success',
              title: 'Updated!',
              text: 'Category updated successfully',
              timer: 1500,
              showConfirmButton: false
            });

          } catch (err) {
            Swal.fire('Error', err.message, 'error');
          }
        }
      });
    });
  });
</script>

<!-- Fade-in animation -->
<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn {
    animation: fadeIn 0.4s ease-out;
  }
</style>

<%- include("../../views/partials/admin/footer") %>
