<%- include("../../views/partials/admin/header") %>

<div class="min-h-screen flex items-center justify-center p-4">
  <div class="max-w-5xl w-full bg-white rounded-xl shadow-lg p-6 space-y-6 ml-8 md:ml-16 lg:ml-24">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pb-4 border-b-2 border-[#1A5D8C]">
      <h1 class="text-[#154b70] text-2xl font-bold">Products</h1>

      <div class="flex items-center gap-3 w-full sm:w-auto">
        <form action="/admin/products" method="get"
              class="flex items-center bg-[#1A5D8C] rounded-md overflow-hidden flex-1 sm:flex-initial">
          <input type="text" name="search" placeholder="Search products..."
                 value="<%= searchQuery || '' %>"
                 class="w-full sm:w-64 px-3 py-2 bg-transparent text-white placeholder-white/70 outline-none text-sm" />
          <button type="submit" class="px-3 py-2 text-sm font-semibold text-[#1A5D8C] bg-white hover:bg-gray-200 transition">
            Search
          </button>
        </form>

       <div class="flex items-center gap-3">
        <% if (searchQuery) { %>
          <a href="/admin/products"
             class="text-[#1A5D8C] underline text-sm whitespace-nowrap hover:text-[#154b70] transition">Clear</a>
        <% } %>


        
       <a href="/admin/addProducts"
         class="bg-[#1A5D8C] hover:bg-[#154b70] text-white font-medium px-4 py-2 rounded-md transition flex items-center gap-2 text-sm whitespace-nowrap">
        <i class="fas fa-plus"></i> Add
      </a>
        </div>

      </div>
    </div>

    <!-- Table -->
     <div id="tableWrapper">
    <div class="flex justify-center">
      <div class="w-full max-w-4xl overflow-x-auto rounded-lg border">
        <table id="productTable" class="w-full text-sm text-left">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Product Name</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Category</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Sale Price</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Discount Price</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Offer %</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Add/remove Offer</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Quantity</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Action</th>
              <th class="px-4 py-3 font-medium text-[#1A5D8C]">Edit</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-200">
             <% products.forEach(product => { %>
             <tr class="hover:bg-gray-50 transition" data-id="<%= product._id %>">
             <td class="px-4 py-3 font-medium"><%= product.productName %></td>
             <td class="px-4 py-3 text-gray-600"><%= product.category ? product.category.name : "Not available" %></td>
             <td class="px-4 py-3">$<%= product.salePrice.toFixed(2) %></td>
             <td class="px-4 py-3">
             <%= product.offerPrice ? `$${product.offerPrice.toFixed(2)}` : 'null' %>
          </td>
          <!-- Offer % -->
               <td class="px-4 py-3 text-center">
               <%= product.offer ? `${product.offer}%` : 'null' %>
               </td>

          <!-- Add / Remove Offer button -->
           <td class="px-4 py-3">
           <% if (!product.offer) { %>
          <button class="bg-[#1A5D8C] hover:bg-[#154b70] text-white px-3 py-1 rounded-md text-xs font-medium transition">
            <a href="#" onclick="addOffer('<%= product._id %>'); return false;" class="text-white no-underline">Add Offer</a>
          </button>
          <% } else { %>
          <button class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-xs font-medium transition">
            <a href="#" onclick="removeOffer('<%= product._id %>'); return false;" class="text-white no-underline">Remove Offer</a>
          </button>
           <% } %>
          </td>

           <td class="px-4 py-3"><%= product.quantity %></td>
 
          <td class="px-4 py-3">
            <% if (!product.isBlocked) { %>
             <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-xs font-medium transition">
             <a href="/admin/blockProduct?id=<%= product._id %>"
             class="text-white no-underline"
             data-action="block">Block</a>
             </button>
            <% } else { %>
             <button class="bg-[#1A5D8C] hover:bg-[#154b70] text-white px-3 py-1 rounded-md text-xs font-medium transition">
             <a href="/admin/unblockProduct?id=<%= product._id %>"
             class="text-white no-underline"
             data-action="unblock">Unblock</a>
           </button>
          <% } %>
         </td>


      <td class="px-4 py-3">
        <button class="bg-[#1A5D8C] hover:bg-[#154b70] text-white px-3 py-1 rounded-md text-xs font-medium transition">
          <a href="/admin/editProduct?id=<%= product._id %>" class="text-white no-underline">Edit</a>
        </button>
      </td>
    </tr>
  <% }) %>
</tbody>
        
        </table>
      </div>
    </div>
    </div>

    <!-- Pagination -->
   <div id="pagination" class="flex justify-center items-center gap-1 py-3">
  <% if (totalPages > 1) { %>
    <% if (currentPage > 1) { %>
      <a href="?page=<%= currentPage - 1 %>" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-100">&lt;</a>
    <% } else { %>
      <span class="px-3 py-1.5 text-gray-400">&lt;</span>
    <% } %>

    <% for (let i = 1; i <= totalPages; i++) { %>
      <% if (i === currentPage) { %>
        <span class="px-3 py-1.5 bg-[#1A5D8C] text-white rounded text-sm"><%= i %></span>
      <% } else { %>
        <a href="?page=<%= i %>" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-100"><%= i %></a>
      <% } %>
    <% } %>

    <% if (currentPage < totalPages) { %>
      <a href="?page=<%= currentPage + 1 %>" class="px-3 py-1.5 border rounded text-sm hover:bg-gray-100">&gt;</a>
    <% } else { %>
      <span class="px-3 py-1.5 text-gray-400">&gt;</span>
    <% } %>
  <% } %>
</div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
const $tableWrapper = $('#tableWrapper');
const $pagination   = $('#pagination');

function replaceTableAndPagination(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const newTable = doc.querySelector('#tableWrapper');
  const newPag   = doc.querySelector('#pagination');

  if (newTable) $tableWrapper.replaceWith(newTable);
  if (newPag)   $pagination.replaceWith(newPag);
}

 //PAGINATION 

$(document).on('click', '#pagination a[href]', async function (e) {
  e.preventDefault();
  const url = new URL(this.href, location.origin);
  try {
    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    const html = await res.text();
    replaceTableAndPagination(html);
    history.pushState({}, '', url);
  } catch (err) {
    Swal.fire('Error', 'Failed to load page', 'error');
  }
});

//SEARCH 

$('#productTable').closest('form').on('submit', async function (e) {
  e.preventDefault();
  const $form = $(this);
  const $btn  = $form.find('button[type="submit"]');
  const old   = $btn.html();
  $btn.html('<span class="spinner"></span>').prop('disabled', true);

  const url = new URL($form.attr('action'), location.origin);
  url.searchParams.set('search', $form.find('input[name="search"]').val().trim());

  try {
    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    const html = await res.text();
    replaceTableAndPagination(html);
    history.pushState({}, '', url);
  } catch (err) {
    Swal.fire('Error', 'Search failed', 'error');
  } finally {
    $btn.html(old).prop('disabled', false);
  }
});


$(document).on('click', 'a[href="/admin/products"]:contains("Clear")', function (e) {
  e.preventDefault();
  location.href = '/admin/products'; 
});

function addOffer(productId) {
  Swal.fire({
    title: 'Add Offer',
    input: 'number',
    inputLabel: 'Offer %',
    inputAttributes: { min: 0, max: 100, step: 1 },
    showCancelButton: true,
    confirmButtonText: 'Add',
    confirmButtonColor: '#1A5D8C'
  }).then(async (result) => {
    if (!result.isConfirmed) return;
    const offerPercent = parseFloat(result.value);

    try {
      const res = await fetch(`/admin/addProductOffer/${productId}/offer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ offerPercent })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed');

      const $row = $(`tr[data-id="${productId}"]`);

      $row.find('td').eq(3).text(`$${data.discountedPrice.toFixed(2)}`);

      $row.find('td').eq(4).text(`${data.offerPercent}%`);

      $row.find('td').eq(5).html(`
        <button class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded-md text-xs font-medium transition">
          <a href="#" onclick="removeOffer('${productId}'); return false;" class="text-white no-underline">Remove Offer</a>
        </button>
      `);

      Swal.fire('Success', `Offer ${data.offerPercent}% applied`, 'success');
    } catch (err) {
      Swal.fire('Error', err.message, 'error');
    }
  });
}

function removeOffer(productId) {
  Swal.fire({
    title: 'Remove offer?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes',
    confirmButtonColor: '#1A5D8C'
  }).then(async (result) => {
    if (!result.isConfirmed) return;

    try {
      const res = await fetch(`/admin/removeProductOffer/${productId}/offer`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed');

      const $row = $(`tr[data-id="${productId}"]`);

      $row.find('td').eq(3).text('N/A');

      $row.find('td').eq(4).text('null');

      $row.find('td').eq(5).html(`
        <button class="bg-[#1A5D8C] hover:bg-[#154b70] text-white px-3 py-1 rounded-md text-xs font-medium transition">
          <a href="#" onclick="addOffer('${productId}'); return false;" class="text-white no-underline">Add Offer</a>
        </button>
      `);

      Swal.fire('Success', 'Offer removed', 'success');
    } catch (err) {
      Swal.fire('Error', err.message, 'error');
    }
  });
}


$(document).on('click', 'a[data-action="block"], a[data-action="unblock"]', async function (e) {
  e.preventDefault();

  const $a        = $(this);
  const href      = $a.attr('href');
  const action    = $a.data('action');               // "block" or "unblock"
  const productId = new URL(href, location.origin).searchParams.get('id');
  const $button   = $a.closest('button');

  const swalRes = await Swal.fire({
    title: `Are you sure you want to ${action} this product?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes',
    confirmButtonColor: action === 'block' ? '#e74c3c' : '#1A5D8C',
  });
  if (!swalRes.isConfirmed) return;

  try {
    const res  = await fetch(href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed');

    if (action === 'block') {
      // Switch to **Unblock**
      $button
        .removeClass('bg-red-600 hover:bg-red-700')
        .addClass('bg-[#1A5D8C] hover:bg-[#154b70]')
        .find('a')
        .text('Unblock')
        .attr('href', `/admin/unblockProduct?id=${productId}`)
        .data('action', 'unblock');
    } else {
      // Switch to **Block**
      $button
        .removeClass('bg-[#1A5D8C] hover:bg-[#154b70]')
        .addClass('bg-red-600 hover:bg-red-700')
        .find('a')
        .text('Block')
        .attr('href', `/admin/blockProduct?id=${productId}`)
        .data('action', 'block');
    }

    Swal.fire('Success!', data.message || `${action === 'block' ? 'Blocked' : 'Unblocked'}`, 'success');
  } catch (err) {
    Swal.fire('Error', err.message, 'error');
  }
});

const style = document.createElement('style');
style.textContent = `
  .spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
`;
document.head.appendChild(style);

window.addEventListener('popstate', () => location.reload());
</script>

<%- include("../../views/partials/admin/footer") %>