<%- include("../../views/partials/admin/header") %>

<div class="main-wrapper min-h-screen bg-gray-100">
  <div class="content-wrapper px-6 py-8 ml-64 xl:ml-64 lg:ml-64 md:ml-0 sm:ml-0 transition-all duration-300">
    <div class="container mx-auto mt-12">
      <div class="card-custom bg-white shadow-md rounded-xl p-6 max-w-5xl mx-auto">

        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-[#1A5D8C] mb-4 md:mb-0">Users</h2>

          <!-- Search Bar -->
          <form id="searchForm" class="flex flex-wrap items-center gap-2">
            <div class="flex items-center border border-gray-300 rounded-md overflow-hidden max-w-md w-full">
              <input 
                type="text"
                id="searchInput"
                placeholder="Search customers..."
                class="flex-1 px-3 py-2 outline-none text-gray-700 text-sm"
                value="<%= typeof search !== 'undefined' ? search : '' %>"
              />
              <button type="submit" class="bg-[#1A5D8C] text-white px-4 py-2 text-sm hover:bg-blue-700 transition">Search</button>
              <button type="button" 
                      id="cancelButton"
                      class="bg-red-500 text-white px-4 py-2 text-sm hover:bg-red-600 transition <%= typeof search !== 'undefined' && search ? '' : 'hidden' %>">
                Cancel
              </button>
            </div>
          </form>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm border border-gray-200 rounded-lg overflow-hidden" id="userTable">
            <thead class="bg-[#1A5D8C] text-white text-left">
              <tr>
                <th class="px-4 py-2">Name</th>
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Phone</th>
                <th class="px-4 py-2">Action</th>
              </tr>
            </thead>
            <tbody>
              <% data.forEach(user => { %>
                <tr class="hover:bg-blue-50 transition border border-gray-200">
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td><%= user.phone %></td>
                  <td>
                    <% if(user.isBlocked){ %>
                      <button class="btn-unblock text-white bg-green-600 px-3 py-1 rounded" data-id="<%= user._id %>">Unblock</button>
                    <% } else { %>
                      <button class="btn-block text-white bg-red-600 px-3 py-1 rounded" data-id="<%= user._id %>">Block</button>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center gap-2 mt-4">

        </div>

      </div>
    </div>
  </div>
</div>

<script>
const searchForm = document.getElementById('searchForm');
const searchInput = document.getElementById('searchInput');
const cancelButton = document.getElementById('cancelButton');
const tableBody = document.querySelector('#userTable tbody');
const paginationDiv = document.getElementById('pagination');

let currentSearch = '<%= typeof search !== "undefined" ? search : "" %>';
let currentPage = <%= currentPage %>;

// Fetch users dynamically
async function fetchUsers(search = '', page = 1) {
  const res = await fetch(`/admin/users?search=${encodeURIComponent(search)}&page=${page}`, {
    headers: { Accept: 'application/json' }
  });
  const data = await res.json();
  renderUsers(data.users);
  renderPagination(data.totalPages, data.currentPage);
}

// Render table
function renderUsers(users) {
  tableBody.innerHTML = '';
  users.forEach(user => {
    const row = document.createElement('tr');
    row.className = 'hover:bg-blue-50 transition';
    row.innerHTML = `
      <td>${user.name}</td>
      <td>${user.email}</td>
      <td>${user.phone}</td>
      <td>
        ${user.isBlocked 
          ? `<button class="btn-unblock text-white bg-green-600 px-3 py-1 rounded" data-id="${user._id}">Unblock</button>` 
          : `<button class="btn-block text-white bg-red-600 px-3 py-1 rounded" data-id="${user._id}">Block</button>`}
      </td>
    `;
    tableBody.appendChild(row);
  });
  attachBlockUnblockListeners();
}

// Pagination buttons
function renderPagination(totalPages, current) {
  paginationDiv.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = `px-3 py-1 rounded ${i === current ? 'bg-[#1A5D8C] text-white' : 'bg-gray-200'}`;
    btn.addEventListener('click', () => {
      currentPage = i;
      fetchUsers(currentSearch, currentPage);
    });
    paginationDiv.appendChild(btn);
  }
}

// Search submit
searchForm.addEventListener('submit', e => {
  e.preventDefault();
  currentSearch = searchInput.value.trim();
  currentPage = 1;
  toggleCancelButton();
  fetchUsers(currentSearch, currentPage);
});

// Cancel search
cancelButton.addEventListener('click', () => {
  searchInput.value = '';
  currentSearch = '';
  currentPage = 1;
  toggleCancelButton();
  fetchUsers('', 1);
});

// Toggle cancel button
function toggleCancelButton() {
  if (searchInput.value.trim() !== '') cancelButton.classList.remove('hidden');
  else cancelButton.classList.add('hidden');
}

// Block/Unblock
function attachBlockUnblockListeners() {
  document.querySelectorAll('.btn-block, .btn-unblock').forEach(button => {
    button.addEventListener('click', async () => {
      const userId = button.dataset.id;
      const isBlocked = button.classList.contains('btn-block');
      const url = isBlocked ? `/admin/blockUser?id=${userId}` : `/admin/unblockUser?id=${userId}`;
      try {
        const res = await fetch(url, { method: 'GET' });
        if (res.ok) fetchUsers(currentSearch, currentPage);
        else alert('Action failed!');
      } catch (err) {
        console.error(err);
        alert('Something went wrong!');
      }
    });
  });
}

// Initial load
fetchUsers(currentSearch, currentPage);
</script>

<%- include("../../views/partials/admin/footer") %>
