<!DOCTYPE html>
<html lang="en">

<head>
  <title>My Orders</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Scoped overrides to avoid header conflicts */
    .main-content * {
      font-family: 'Nunito Sans', sans-serif;
    }

    .main-content {
      background-color: #f9fdff;
      margin-top: 120px;
      padding: 20px 0;
      min-height: 100vh;
    }
    
    .breadcrumb {
      background: none !important;
      padding: 0;
      margin-bottom: 10px;
      margin-left: 200px;
      margin-top: 30px;
    }

    .breadcrumb-item a {
      color: #2d3436;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: #ff3368;
    }

    .breadcrumb-item.active {
      color: #d50909;
    }

    .page-title {
      color: #2d3436;
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 25px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    .order-card {
      background: white;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
    }

    .order-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #ff3368, #ff6b9d);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }

    .order-card:hover::before {
      transform: scaleX(1);
    }

    .order-header {
      padding: 19px 20px;
      background: linear-gradient(135deg, #ff3368);
      color: white;
    }

    .order-header h5 {
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: white;
    }

    .order-header p {
      font-size: 0.9rem;
      margin: 0;
      opacity: 0.9;
      color: white;
    }

    .order-body {
      padding: 15px 20px;
    }

    .status-badge {
      padding: 9px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 80px;
      text-align: center;
    }

    .btn-view,
    .btn-action {
      border-radius: 8px;
      font-size: 0.85rem;
      padding: 6px 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      margin: 0 2px;
      color: white !important;
    }

    .btn-view {
      background: linear-gradient(#245e85);
      color: white;
      border: none;
    }

    .btn-view:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 51, 104, 0.3);
      color: white;
    }

    .btn-outline-primary,
    .btn-outline-danger {
      border: 2px solid;
      color: inherit;
    }

    .btn-outline-primary {
      border-color: #0d6efd;
      color: #0d6efd;
    }

    .btn-outline-primary:hover {
      background: #0d6efd;
      color: white;
      transform: translateY(-1px);
    }

    .btn-outline-danger {
      border-color: #dc3545;
      color: #dc3545;
    }

    .btn-outline-danger:hover {
      background: #dc3545;
      color: white;
      transform: translateY(-1px);
    }

    .btn-outline-secondary {
      border-color: #6c757d;
      color: #6c757d;
      font-size: 0.85rem;
    }

    .btn-outline-secondary:hover {
      background: #6c757d;
      color: white;
      transform: translateY(-1px);
    }

    .no-orders {
      text-align: center;
      color: #636e72;
      font-size: 1.1rem;
      margin-top: 40px;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }

    .no-orders i {
      font-size: 3.5rem;
      color: #ff3368;
      margin-bottom: 15px;
      opacity: 0.7;
    }

    .search-form {
      max-width: 500px;
      margin: 0 auto 25px;
      background: white;
      padding: 15px;
      border-radius: 15px;
    }

    .search-form .input-group {
      box-shadow: none;
    }

    .search-form .btn {
      background: linear-gradient(135deg, #ff3368, #ff6b9d);
      border: none;
      color: white;
      border-radius: 0 15px 15px 0;
    }

    .search-form input {
      border-radius: 15px 0 0 15px;
    }

    .info-row p {
      font-size: 0.95rem;
      margin-bottom: 5px;
      color: #636e72;
    }

    .info-row strong {
      color: #2d3436;
    }

    .product-preview {
      font-size: 0.9rem;
      color: #636e72;
      margin-top: 5px;
      font-style: italic;
    }

    .product-preview i {
      color: #ff3368;
      margin-right: 5px;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-top: 80px;
        padding: 15px;
      }

      .order-header,
      .order-body {
        padding: 12px 15px;
      }

      .btn-view,
      .btn-action {
        font-size: 0.8rem;
        padding: 4px 8px;
      }

      .search-form {
        margin: 0 10px 20px;
      }

      .product-preview {
        font-size: 0.85rem;
      }
    }

    /* Suppress duplicates from header include to prevent search crashes */
    body>html,
    body>head,
    body>body {
      display: none !important;
    }

    header:nth-of-type(n+2) {
      display: none !important;
    }
  </style>
</head>

<body>
  <%- include("../partials/user/header") %>
    <main class="main-content">
      <div class="custom">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="/userProfile" rel="nofollow">
                <i class="fas fa-user"></i> User Profile
              </a>
            </li>

            <li class="breadcrumb-item active" aria-current="page">
               <a href="/orders">
              <i class="fas fa-shopping-bag "></i> Orders
              </a>
            </li>
          </ol>
        </nav>
      </div>
      <div class="container">
        <h1 class="page-title"><i class="fas fa-shopping-bag me-2"></i> My Orders</h1>

        <!-- Search Form (Compact, Card-like) -->
        <form action="/orders" method="GET" class="search-form">
          <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Search by Order ID or Product Name..."
              value="<%= searchQuery || '' %>">
            <button class="btn" type="submit"><i class="fas fa-search"></i></button>
          </div>
        </form>

        <% if (orders && orders.length> 0) { %>
          <div class="row">
            <% orders.forEach(order=> { %>
              <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="order-card h-100">
                  <div class="order-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="mb-1">#<%= order.orderId %>
                        </h5>
                        <p class="mb-0 small">Placed: <%= new Date(order.createdOn).toLocaleDateString('en-IN') %>
                        </p>
                      </div>
                      <span
                        class="status-badge <%= order.status === 'Delivered' ? 'bg-success' : order.status === 'Cancelled' ? 'bg-danger' : order.status === 'Pending' ? 'bg-warning text-dark' : 'bg-secondary' %>">
                        <%= order.status %>
                      </span>
                    </div>
                  </div>
                  <div class="order-body">
                    <div class="info-row">
                      <p><strong>Ship to:</strong>
                        <%= order.address.name %>, <%= order.address.city %>
                      </p>
                      <p><strong>Total:</strong> â‚¹<%= order.finalAmount.toFixed(2) %>
                      </p>
                      <p class="small mb-2"><strong>Payment:</strong>
                        <%= order.paymentMethod %>
                      </p>
                      <!-- NEW: Product Name Preview (first product) -->
                      <% if (order.orderedItems && order.orderedItems.length> 0) { %>
                        <p class="product-preview">
                          <i class="fas fa-tag"></i>
                          Includes: <%= order.orderedItems[0].product ? order.orderedItems[0].product.productName
                            : 'Product' %>
                            <% if (order.orderedItems.length> 1) { %> +<%= order.orderedItems.length - 1 %> more <% } %>
                        </p>
                        <% } %>
                    </div>
                    <div class="d-flex flex-wrap gap-1 mt-2 justify-content-end">
                      <a href="/orders/<%= order._id %>" class="btn btn-view btn-sm">
                        <i class="fas fa-eye me-1"></i> View
                      </a>
                      <% if (order.status==='Delivered' ) { %>
                        <button class="btn btn-outline-primary btn-sm" onclick="requestReturn('<%= order._id %>')">
                          <i class="fas fa-undo me-1"></i> Return
                        </button>
                        <% } else if (order.status==='Pending' || order.status==='Processing' ) { %>
                          <button class="btn btn-outline-danger btn-sm" onclick="confirmCancel('<%= order._id %>')">
                            <i class="fas fa-times me-1"></i> Cancel
                          </button>
                          <% } %>
                            <a href="/orders/<%= order._id %>/invoice" class="btn btn-outline-secondary btn-sm">
                              <i class="fas fa-download me-1"></i> PDF
                            </a>
                    </div>
                  </div>
                </div>
              </div>
              <% }) %>
          </div>
          <% } else { %>
            <div class="no-orders">
              <i class="fas fa-inbox"></i>
              <p>No orders found<%= searchQuery ? ` for "<strong>${searchQuery}</strong>" ` : '' %>. <a href="/"
                    class="text-decoration-none fw-bold" style="color: #ff3368;">Start shopping!</a></p>
            </div>
            <% } %>
      </div>
    </main>
    <%- include("../partials/user/footer") %>

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script>
        async function confirmCancel(orderId) {
          const { value: reason } = await Swal.fire({
            title: 'Cancel Order?',
            text: 'This cannot be undone.',
            input: 'textarea',
            inputPlaceholder: 'Optional reason...',
            inputAttributes: { rows: 2 },
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Cancel Order'
          });
          if (value !== null) { // Allow empty
            try {
              const response = await fetch(`/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: value || 'No reason provided' })
              });
              const data = await response.json();
              if (data.success) {
                Swal.fire('Cancelled!', data.message, 'success').then(() => location.reload());
              } else {
                Swal.fire('Error!', data.message, 'error');
              }
            } catch (error) {
              Swal.fire('Error!', 'Failed to cancel.', 'error');
            }
          }
        }

        async function requestReturn(orderId) {
          const { value: reason } = await Swal.fire({
            title: 'Return Order?',
            text: 'Provide a reason for return.',
            input: 'textarea',
            inputPlaceholder: 'Reason (required)...',
            inputAttributes: { rows: 3 },
            inputValidator: (value) => !value && 'Reason is required!',
            showCancelButton: true,
            confirmButtonColor: '#ff3368',
            confirmButtonText: 'Submit Return'
          });
          if (value) {
            try {
              const response = await fetch(`/orders/${orderId}/return`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: value })
              });
              const data = await response.json();
              if (data.success) {
                Swal.fire('Submitted!', data.message, 'success').then(() => location.reload());
              } else {
                Swal.fire('Error!', data.message, 'error');
              }
            } catch (error) {
              Swal.fire('Error!', 'Failed to return.', 'error');
            }
          }
        }
      </script>
</body>

</html>