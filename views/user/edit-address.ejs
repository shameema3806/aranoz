<!DOCTYPE html>
<html lang="en">
<head>
  <title>Edit Address</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f9fdff;
      margin: 0;
      padding: 0;
      padding-top: 90px !important;
    }
    .edit-wrapper {
      background-color: #f9fdff;
      min-height: 100vh;
      padding: 40px 0;
    }
    .page-title {
      color: #2d3436;
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }
    .breadcrumb {
      background: none;
      padding: 0;
      margin-bottom: 20px;
    }
    .breadcrumb-item a {
      color: #2d3436;
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .breadcrumb-item a:hover {
      color: #ff3368;
    }
    .breadcrumb-item.active {
      color: #636e72;
    }
    .edit-section {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      max-width: 800px;
      margin: 0 auto;
    }
    .edit-section:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }
    .section-header {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 25px 30px;
      border-bottom: 3px solid #ff3368;
    }
    .section-header h3 {
      margin: 0;
      color: #2d3436;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
    }
    .section-header h3 i {
      color: #ff3368;
      font-size: 28px;
    }
    .section-content {
      padding: 35px;
    }
    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    .required {
      color: #ff3368;
      margin-left: 3px;
    }
    .form-control, .form-select, .btn.dropdown-toggle {
      border-radius: 12px;
      border: 2px solid #dee2e6;
      padding: 0.85rem 1.1rem;
      transition: all 0.3s ease;
      font-size: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    .form-control:focus, .form-select:focus, .btn.dropdown-toggle:focus {
      border-color: #ff3368;
      box-shadow: 0 0 0 0.25rem rgba(255, 51, 104, 0.15);
      outline: none;
      background: white;
    }
    .form-control:hover, .form-select:hover, .btn.dropdown-toggle:hover {
      border-color: #ff3368;
      background: white;
    }
    .dropdown-toggle {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
      border: 2px solid #dee2e6 !important;
      color: #495057 !important;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dropdown-toggle:hover, .dropdown-toggle:focus {
      border-color: #ff3368 !important;
      background: white !important;
      box-shadow: 0 0 0 0.25rem rgba(255, 51, 104, 0.15) !important;
    }
    .dropdown-menu {
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      border: 2px solid #ff3368;
      padding: 0.5rem 0;
    }
    .dropdown-item {
      padding: 0.75rem 1.25rem;
      transition: all 0.2s ease;
      color: #2d3436;
      font-weight: 500;
    }
    .dropdown-item:hover {
      background: linear-gradient(135deg, #fff5f8 0%, #ffe8f0 100%);
      color: #ff3368;
      padding-left: 1.5rem;
    }
    .btn-primary-custom {
      background: linear-gradient(135deg, #ff3368, #ff6b9d);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.85rem 2rem;
      font-weight: 700;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 5px 20px rgba(255, 51, 104, 0.4);
      font-size: 1rem;
    }
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(255, 51, 104, 0.6);
      color: white;
    }
    .btn-secondary-custom {
      background: white;
      color: #636e72;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 0.85rem 2rem;
      font-weight: 700;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
    }
    .btn-secondary-custom:hover {
      background: #636e72;
      color: white;
      border-color: #636e72;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(99, 110, 114, 0.3);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
      padding-top: 25px;
      border-top: 2px solid #f1f3f5;
    }
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .button-group {
        flex-direction: column;
      }
      .btn-primary-custom,
      .btn-secondary-custom {
        width: 100%;
        justify-content: center;
      }
      .section-content {
        padding: 25px 20px;
      }
    }

    /* CHANGE: Added styles for error messages and form control states for validation feedback */
    .error {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: block;
      min-height: 1rem;  /* Prevents layout jump when errors appear */
    }
    .form-control.error {
      border-color: #dc3545;
      background: #fff5f5;
    }
    .form-control.valid {
      border-color: #28a745;
      background: #f8fff8;
    }
  </style>
</head>
<body>
  <div class="edit-wrapper">
    <div class="container">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/" rel="nofollow">
              <i class="fas fa-home"></i> Home
            </a>
          </li>
          <li class="breadcrumb-item">
            <a href="/userProfile">
              <i class="fas fa-user"></i> Profile
            </a>
          </li>
          <li class="breadcrumb-item">
            <a href="/addresses" rel="nofollow">
              <i class="fas fa-map-marker-alt"></i> Manage Addresses
            </a>
          </li>
          <li class="breadcrumb-item active">Edit Address</li>
        </ol>
      </nav>

      <!-- Page Title -->
      <h1 class="page-title">
        <i class="fas fa-edit"></i> Edit Address
      </h1>

      <!-- Edit Address Section -->
      <div class="edit-section">
        <div class="section-header">
          <h3>
            <i class="fas fa-map-marked-alt"></i>
            Update Your Address Details
          </h3>
        </div>
        <div class="section-content">
          <!-- CHANGE: Added 'novalidate' attribute to form to disable browser's default validation, allowing custom JS to handle it -->
          <form action="/addresses/edit/<%= index %>" method="POST" novalidate>
            <input type="hidden" name="addressType" id="addressTypeHidden" value="<%= address.addressType %>">

            <!-- Address Type Dropdown -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-tag"></i> Address Type <span class="required">*</span>
              </label>
              <button class="btn dropdown-toggle w-100" type="button" id="addressTypeDropdown" data-bs-toggle="dropdown">
                <span id="addressTypeSelected"><%= address.addressType.charAt(0).toUpperCase() + address.addressType.slice(1) %></span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <ul class="dropdown-menu w-100">
                <li><a class="dropdown-item" href="#" data-value="home"><i class="fas fa-home"></i> Home</a></li>
                <li><a class="dropdown-item" href="#" data-value="work"><i class="fas fa-briefcase"></i> Work</a></li>
                <li><a class="dropdown-item" href="#" data-value="other"><i class="fas fa-map-pin"></i> Other</a></li>
              </ul>
              <!-- CHANGE: Added error div for addressType field validation feedback -->
              <div id="addressTypeError" class="error"></div>
            </div>

            <!-- Full Name -->
            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-user"></i> Full Name <span class="required">*</span>
              </label>
              <input type="text" class="form-control" name="name" required value="<%= address.name %>" placeholder="Enter full name">
              <!-- CHANGE: Added error div for name field validation feedback -->
              <div id="nameError" class="error"></div>
            </div>
            
            <!-- City and State Row -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-city"></i> City <span class="required">*</span>
                </label>
                <input type="text" class="form-control" name="city" required value="<%= address.city %>" placeholder="Enter city">
                <!-- CHANGE: Added error div for city field validation feedback -->
                <div id="cityError" class="error"></div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-map"></i> State <span class="required">*</span>
                </label>
                <input type="text" class="form-control" name="state" required value="<%= address.state %>" placeholder="Enter state">
                <!-- CHANGE: Added error div for state field validation feedback -->
                <div id="stateError" class="error"></div>
              </div>
            </div>

            <!-- Landmark and PIN Code Row -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-landmark"></i> Landmark <span class="required">*</span>
                </label>
                <input type="text" class="form-control" name="landMark" required value="<%= address.landMark %>" placeholder="Enter landmark">
                <!-- CHANGE: Added error div for landMark field validation feedback -->
                <div id="landMarkError" class="error"></div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-mailbox"></i> PIN Code <span class="required">*</span>
                </label>
                <input type="number" class="form-control" name="pincode" required value="<%= address.pincode %>" placeholder="Enter PIN code">
                <!-- CHANGE: Added error div for pincode field validation feedback -->
                <div id="pincodeError" class="error"></div>
              </div>
            </div>

            <!-- Phone and Alternate Phone Row -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-phone"></i> Phone <span class="required">*</span>
                </label>
                <input type="text" class="form-control" name="phone" required value="<%= address.phone %>" placeholder="Enter phone number">
                <!-- CHANGE: Added error div for phone field validation feedback -->
                <div id="phoneError" class="error"></div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-phone-alt"></i> Alternate Phone <span class="required">*</span>
                </label>
                <input type="text" class="form-control" name="allPhone" required value="<%= address.allPhone %>" placeholder="Enter alternate phone">
                <!-- CHANGE: Added error div for allPhone field validation feedback -->
                <div id="allPhoneError" class="error"></div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
              <a href="/addresses" class="btn-secondary-custom">
                <i class="fas fa-times"></i> Cancel
              </a>
              <button type="submit" class="btn-primary-custom">
                <i class="fas fa-save"></i> Update Address
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const dropdownItems = document.querySelectorAll('#addressTypeDropdown ~ .dropdown-menu .dropdown-item');
      const selectedSpan = document.getElementById('addressTypeSelected');
      const hiddenInput = document.getElementById('addressTypeHidden');

      // Dropdown selection
      dropdownItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const value = this.getAttribute('data-value');
          const text = value.charAt(0).toUpperCase() + value.slice(1);
          
          selectedSpan.textContent = text;
          hiddenInput.value = value;

          // Close dropdown
          const dropdownElement = document.getElementById('addressTypeDropdown');
          const dropdown = bootstrap.Dropdown.getInstance(dropdownElement);
          if (dropdown) dropdown.hide();

          /* CHANGE: Clear addressType error on selection */
          const addressTypeError = document.getElementById('addressTypeError');
          if (addressTypeError) {
            addressTypeError.textContent = '';
            dropdownElement.classList.remove('error');
            dropdownElement.classList.add('valid');
          }
        });
      });

      /* CHANGE: Added separate validation functions for each address field */
      // Validate Address Type (dropdown)
      function validateAddressType() {
        const dropdownElement = document.getElementById('addressTypeDropdown');
        const error = document.getElementById('addressTypeError');
        const value = hiddenInput.value;
        error.textContent = '';
        dropdownElement.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'Address type is required.';
          dropdownElement.classList.add('error');
          return false;
        }
        dropdownElement.classList.add('valid');
        return true;
      }

      // Validate Name
      function validateName() {
        const input = document.querySelector('[name="name"]');
        const error = document.getElementById('nameError');
        const value = input.value.trim();
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'Full name is required.';
          input.classList.add('error');
          return false;
        }
        if (!/^[a-zA-Z\s]{2,}$/.test(value)) {
          error.textContent = 'Name must be at least 2 characters and contain only letters/spaces.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      // Validate City
      function validateCity() {
        const input = document.querySelector('[name="city"]');
        const error = document.getElementById('cityError');
        const value = input.value.trim();
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'City is required.';
          input.classList.add('error');
          return false;
        }
        if (!/^[a-zA-Z\s]+$/.test(value)) {
          error.textContent = 'City must contain only letters and spaces.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      // Validate State
      function validateState() {
        const input = document.querySelector('[name="state"]');
        const error = document.getElementById('stateError');
        const value = input.value.trim();
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'State is required.';
          input.classList.add('error');
          return false;
        }
        if (!/^[a-zA-Z\s]+$/.test(value)) {
          error.textContent = 'State must contain only letters and spaces.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      // Validate Landmark
      function validateLandMark() {
        const input = document.querySelector('[name="landMark"]');
        const error = document.getElementById('landMarkError');
        const value = input.value.trim();
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'Landmark is required.';
          input.classList.add('error');
          return false;
        }
        if (value.length < 2) {
          error.textContent = 'Landmark must be at least 2 characters.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      // Validate Pincode
      function validatePincode() {
        const input = document.querySelector('[name="pincode"]');
        const error = document.getElementById('pincodeError');
        const value = input.value.trim();
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'PIN code is required.';
          input.classList.add('error');
          return false;
        }
        const num = Number(value);
        if (isNaN(num) || value.length !== 6) {
          error.textContent = 'PIN code must be a valid 6-digit number.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      // Validate Phone
      function validatePhone() {
        const input = document.querySelector('[name="phone"]');
        const error = document.getElementById('phoneError');
        const value = input.value.replace(/[\s\-\(\)\+]/g, '');
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'Phone is required.';
          input.classList.add('error');
          return false;
        }
        if (!/^\d{10}$/.test(value)) {
          error.textContent = 'Phone must be a valid 10-digit number.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      // Validate All Phone
      function validateAllPhone() {
        const input = document.querySelector('[name="allPhone"]');
        const error = document.getElementById('allPhoneError');
        const value = input.value.replace(/[\s\-\(\)\+]/g, '');
        error.textContent = '';
        input.classList.remove('error', 'valid');
        if (!value) {
          error.textContent = 'Alternate phone is required.';
          input.classList.add('error');
          return false;
        }
        if (!/^\d{10}$/.test(value)) {
          error.textContent = 'Alternate phone must be a valid 10-digit number.';
          input.classList.add('error');
          return false;
        }
        input.classList.add('valid');
        return true;
      }

      /* CHANGE: Added event listeners for real-time validation on blur for all address inputs (addressType on dropdown click already handled) */
      const nameInput = document.querySelector('[name="name"]');
      if (nameInput) nameInput.addEventListener('blur', validateName);
      const cityInput = document.querySelector('[name="city"]');
      if (cityInput) cityInput.addEventListener('blur', validateCity);
      const stateInput = document.querySelector('[name="state"]');
      if (stateInput) stateInput.addEventListener('blur', validateState);
      const landMarkInput = document.querySelector('[name="landMark"]');
      if (landMarkInput) landMarkInput.addEventListener('blur', validateLandMark);
      const pincodeInput = document.querySelector('[name="pincode"]');
      if (pincodeInput) pincodeInput.addEventListener('blur', validatePincode);
      const phoneInput = document.querySelector('[name="phone"]');
      if (phoneInput) phoneInput.addEventListener('blur', validatePhone);
      const allPhoneInput = document.querySelector('[name="allPhone"]');
      if (allPhoneInput) allPhoneInput.addEventListener('blur', validateAllPhone);

      // Form validation before submit
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', function(e) {
          /* CHANGE: Enhanced submit handler to validate all fields and addressType separately before submission */
          const isAddressTypeValid = validateAddressType();
          if (!isAddressTypeValid) {
            e.preventDefault();
            // Swal.fire({
            //   title: 'Error!',
            //   text: 'Please select an Address Type.',
            //   icon: 'error',
            //   confirmButtonColor: '#ff3368'
            // });
            // return;
          }
          const isValid = validateName() && validateCity() && validateState() && validateLandMark() && validatePincode() && validatePhone() && validateAllPhone();
          if (!isValid) {
            e.preventDefault();
            // Swal.fire({
            //   title: 'Error!',
            //   text: 'Please fix the errors above before submitting.',
            //   icon: 'error',
            //   confirmButtonColor: '#ff3368'
            // });
          }
        });
      }

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('updated') === 'true') {
        Swal.fire({
          title: 'Updated!',
          text: 'Your address has been updated successfully.',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end',
          background: '#fff5f8',
          color: '#2d3436',
          iconColor: '#ff3368'
        }).then(() => {
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
        });
      }
    });
  </script>
</body>
</html>