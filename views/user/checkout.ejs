<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f9fdff;
            margin: 0;
            padding: 0;
            padding-top: 90px !important;
        }
        .checkout-wrapper {
            background-color: #f9fdff;
            min-height: 100vh;
            padding: 40px 0;
        }
        .page-title {
            color: #2d3436;
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }
        .checkout-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 30px;
            margin-top: 20px;
        }
        /* Left Column Centering */
        .left-column {
            max-width: 700px;
            margin: 0 auto;
        }
        /* Section Cards */
        .checkout-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        .checkout-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }
        .section-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 20px 25px;
            border-bottom: 3px solid #ff3368;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header h3 {
            margin: 0;
            color: #2d3436;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        .section-header h3 i {
            color: #ff3368;
            font-size: 28px;
        }
        .section-content {
            padding: 25px;
        }
        /* Address Cards */
        .address-card {
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            overflow: hidden;
        }
        .address-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff3368, #ff6b9d);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .address-card:hover {
            border-color: #ff3368;
            box-shadow: 0 8px 25px rgba(255, 51, 104, 0.2);
            transform: translateY(-3px);
        }
        .address-card.selected {
            border-color: #ff3368;
            background: linear-gradient(135deg, #fff5f8 0%, #ffe8f0 100%);
            box-shadow: 0 5px 20px rgba(255, 51, 104, 0.3);
        }
        .address-card.selected::before {
            transform: scaleX(1);
        }
        .address-info h4 {
            margin: 0 0 10px;
            color: #2d3436;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .address-info h4 i {
            color: #ff3368;
        }
        .address-info p {
            margin: 0 0 6px;
            color: #636e72;
            line-height: 1.6;
            font-size: 14px;
        }
        .address-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        .add-address-card {
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #2d3436;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .add-address-card:hover {
            border-color: #ff3368;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 51, 104, 0.1);
        }
        .add-address-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
            color: #ff3368;
        }
        .add-address-card h4 {
            color: #2d3436;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .add-address-card p {
            color: #636e72;
            margin: 0;
        }
        /* Payment Methods */
        .payment-method {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .payment-method:hover {
            border-color: #ff3368;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 51, 104, 0.2);
        }
        .payment-method.selected {
            border-color: #ff3368;
            background: linear-gradient(135deg, #fff5f8 0%, #ffe8f0 100%);
            box-shadow: 0 5px 20px rgba(255, 51, 104, 0.3);
        }
        .payment-icon {
            width: 50px;
            height: 50px;
            background: #f8f9fa;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff3368;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .payment-method.selected .payment-icon {
            background: #ff3368;
            color: white;
        }
        .payment-info h4 {
            margin: 0 0 5px;
            color: #2d3436;
            font-weight: 700;
        }
        .payment-info p {
            margin: 0;
            color: #636e72;
            font-size: 0.9rem;
        }
        /* Order Items */
        .checkout-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border: 1px solid #f1f3f5;
        }
        .checkout-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .checkout-item:last-child {
            margin-bottom: 0;
        }
        .item-image {
            width: 90px;
            height: 90px;
            border-radius: 12px;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid #dee2e6;
        }
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .item-details {
            flex: 1;
        }
        .item-name {
            font-weight: 700;
            color: #2d3436;
            margin: 0 0 8px;
            font-size: 1.1rem;
        }
        .item-quantity {
            color: #636e72;
            font-size: 0.95rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .item-price {
            color: #ff3368;
            font-weight: 700;
            font-size: 1.2rem;
        }
        /* Order Summary Sidebar */
        .order-summary {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        .summary-title {
            margin: 0 0 25px;
            color: #2d3436;
            font-weight: 700;
            font-size: 1.4rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #ff3368;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f5;
        }
        .summary-row:last-of-type {
            border-bottom: none;
        }
        .summary-row.total {
            border-top: 3px solid #ff3368;
            padding-top: 20px;
            margin-top: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3436;
        }
        .summary-row.total span:last-child {
            color: #ff3368;
        }
        .summary-label {
            color: #636e72;
            font-weight: 600;
        }
        .summary-value {
            color: #2d3436;
            font-weight: 700;
        }
        .summary-value.discount {
            color: #28a745;
        }
        .summary-value.free {
            color: #28a745;
        }
        /* Place Order Button */
        .place-order-btn {
            width: 100%;
            background: linear-gradient(135deg, #ff3368, #ff6b9d);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 8px 25px rgba(255, 51, 104, 0.4);
        }
        .place-order-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 51, 104, 0.6);
        }
        .place-order-btn:disabled {
            background: #dee2e6;
            cursor: not-allowed;
            transform: none;
        }
        .place-order-btn i {
            font-size: 20px;
        }
        /* Security Info */
        .security-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #636e72;
            font-size: 0.9rem;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f1f3f5;
            text-align: center;
        }
        .security-info i {
            color: #28a745;
            font-size: 1.2rem;
        }
        /* Buttons */
        .btn-custom {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .btn-primary-custom {
            background: linear-gradient(135deg, #ff3368, #ff6b9d);
            color: white;
            border: 2px solid #ff3368;
            box-shadow: 0 5px 20px rgba(255, 51, 104, 0.4);
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 51, 104, 0.6);
        }
        .btn-outline-custom {
            background: white;
            color: #ff3368;
            border: 2px solid #ff3368;
        }
        .btn-outline-custom:hover {
            background: #ff3368;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 51, 104, 0.3);
        }
        .btn-danger-custom {
            background: white;
            color: #dc3545;
            border: 2px solid #dc3545;
        }
        .btn-danger-custom:hover {
            background: #dc3545;
            color: white;
        }
        .btn-add-new {
            background: white;
            color: #ff3368;
            border: 2px solid #ff3368;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .btn-add-new:hover {
            background: #ff3368;
            color: white;
        }
        /* Responsive Design */
        @media (max-width: 1024px) {
            .checkout-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .order-summary {
                position: static;
            }
            .left-column {
                max-width: none;
                margin: 0;
                order: -1;
            }
        }
        @media (max-width: 768px) {
            .checkout-item {
                flex-direction: column;
                text-align: center;
            }
            .item-image {
                margin: 0 auto;
            }
            .address-actions {
                flex-direction: column;
            }
            .btn-custom {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <%- include('../partials/user/header.ejs') %>
        <div class="checkout-wrapper">
            <div class="container">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb" style="background: none; padding: 0;">
                        <li class="breadcrumb-item"><a href="/" style="color: #2d3436; text-decoration: none;">Home</a>
                        </li>
                        <li class="breadcrumb-item"><a href="/cart"
                                style="color: #2d3436; text-decoration: none;">Cart</a></li>
                        <li class="breadcrumb-item active" style="color: #636e72;">Checkout</li>
                    </ol>
                </nav>
                <h1 class="page-title">Checkout</h1>
                <div class="checkout-container">
                    <!-- Left Column -->
                    <div class="left-column">
                        <!-- Shipping Address Section -->
                        <div class="checkout-section">
                            <div class="section-header">
                                <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
                                <a href="/addresses?redirect=checkout" class="btn-add-new">
                                    <i class="fas fa-plus"></i> Add New
                                </a>
                            </div>
                            <div class="section-content">
                                <% if (addresses && addresses.length> 0) { %>
                                    <% addresses.forEach((address)=> { %>
                                        <div class="address-card <%= address.isDefault ? 'selected' : '' %>"
                                            onclick="selectAddress('<%= address._id %>')"
                                            data-address-id="<%= address._id %>">
                                            <div class="address-info">
                                                <h4>
                                                    <i class="fas fa-home"></i>
                                                    <%= address.firstName %>
                                                        <%= address.lastName %>
                                                            <span
                                                                style="font-size: 0.85rem; color: #ff3368; font-weight: 600;">
                                                                (<%= address.addressType.charAt(0).toUpperCase() +
                                                                    address.addressType.slice(1) %>)
                                                            </span>
                                                </h4>
                                                <p><strong>Phone:</strong>
                                                    <%= address.phone %>
                                                </p>
                                                <p>
                                                    <%= address.address %>
                                                </p>
                                                <p>
                                                    <%= address.state %>, <%= address.pinCode %>
                                                </p>
                                               
                                            </div>
                                            <div class="address-actions">
                                                <button class="btn-custom btn-outline-custom"
                                                    onclick="editAddress('<%= address._id %>', event)">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <!-- <button class="btn-custom btn-danger-custom"
                                                    onclick="deleteAddress('<%= address._id %>', event)">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button> -->
                                            </div>
                                        </div>
                                        <% }); %>
                                            <% } %>
                                                <!-- Add New Address Card -->
                                                <!-- <div class="add-address-card" onclick="openAddressModal()">
                                                    <i class="fas fa-plus-circle"></i>
                                                    <h4>Add New Address</h4>
                                                    <p>Add a new shipping address for delivery</p>
                                                </div> -->
                            </div>
                        </div>
                        <!-- Payment Method Section -->
                        <div class="checkout-section">
                            <div class="section-header">
                                <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
                            </div>
                            <div class="section-content">
                                <div class="payment-method selected" onclick="selectPayment('cod')" data-payment="cod">
                                    <div class="payment-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="payment-info">
                                        <h4>Cash on Delivery</h4>
                                        <p>Pay with cash when your order is delivered</p>
                                    </div>
                                </div>
                                <div class="payment-method" onclick="selectPayment('online')" data-payment="online">
                                    <div class="payment-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="payment-info">
                                        <h4>Online Payment</h4>
                                        <p>Pay securely with Razorpay (UPI, Cards, Net Banking)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Order Items Section -->
                        <div class="checkout-section">
                            <div class="section-header">
                                <h3><i class="fas fa-shopping-bag"></i> Order Items (<%= itemCount %> items)</h3>
                            </div>
                            <div class="section-content">
                                <% cart.products.forEach((product)=> { %>
    <div class="checkout-item">
        <div class="d-flex justify-content-center align-items-center p-2">
            <a href="/productDetail?id=<%= product.productId._id %>">
                <img 
                    src="<%= product.productId.productImage.length > 0 
                        ? '/public/product-images/' + product.productId.productImage[0] 
                        : '/img/product/placeholder.jpg' %>" 
                    alt="<%= product.productId.productName %>"
                    width="100" height="100" class="img-fluid rounded" />
            </a>  <!-- <-- FIXED: Close <a> IMMEDIATELY after <img> -->
        </div>  <!-- <-- Now safely closes d-flex (outside <a>) -->
        <div class="item-details">  <!-- <-- Now safely OUTSIDE <a> -->
            <h4 class="item-name">
                <%= product.productName %>
            </h4>
            <div class="item-quantity">Quantity: <%= product.quantity %></div>
            <div class="item-price">₹<%= (product.price * product.quantity).toFixed(2) %></div>
        </div>
    </div>  <!-- <-- checkout-item closes cleanly -->
<% }); %>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column - Order Summary -->
                    <div class="order-summary">
                        <h3 class="summary-title"><i class="fas fa-receipt"></i> Order Summary</h3>
                        <div class="summary-row">
                            <span class="summary-label">Subtotal (<%= itemCount %> items)</span>
                            <span class="summary-value">₹<%= subtotal %></span>
                        </div>
                        <!-- COMMENTED OUT COUPON DIV -->
                        <!--
                        <div style="margin-bottom: 15px;">
                          <button class="place-order-btn" style="background: #f9f6f1; color: #8B7355; border: 2px solid #8B7355; margin-top: 0; width: 100%;" onclick="openCouponModal()">
                            <i class="fas fa-ticket-alt"></i> Apply Coupon
                          </button>
                        </div>
                        -->
                        <% if (parseFloat(discount) > 0) { %>
                          <div class="summary-row">
                            <span class="summary-label">Discount</span>
                            <span class="summary-value discount">-₹<%= discount %></span>
                          </div>
                        <% } %>
                        <div class="summary-row">
                            <span class="summary-label">Shipping</span>
                            <span class="summary-value <%= parseFloat(shipping) === 0 ? 'free' : '' %>">
                                <%= parseFloat(shipping)===0 ? 'Free' : '₹' + shipping %>
                            </span>
                        </div>
                        <% if (parseFloat(tax)> 0) { %>
                            <div class="summary-row">
                                <span class="summary-label">Tax (GST)</span>
                                <span class="summary-value">₹<%= tax %></span>
                            </div>
                            <% } %>
                                <div class="summary-row total">
                                    <span>Total Amount</span>
                                    <span>₹<%= total %></span>
                                </div>
                                <button class="place-order-btn" onclick="placeOrder()" id="placeOrderBtn">
                                    <i class="fas fa-lock"></i> Place Order
                                </button>
                                <div class="security-info">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Your payment information is secure and encrypted</span>
                                </div>
                    </div>
                </div>
            </div>
            <%- include('../partials/user/footer.ejs') %>




<script>
    let selectedAddressId = '<%= addresses.find(addr => addr.isDefault)?._id || (addresses.length > 0 ? addresses[0]._id : "") %>';
    let selectedPaymentMethod = 'cod';
    function selectAddress(addressId) {
        document.querySelectorAll('.address-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelector(`[data-address-id="${addressId}"]`).classList.add('selected');
        selectedAddressId = addressId;
    }
    function selectPayment(paymentMethod) {
        document.querySelectorAll('.payment-method').forEach(method => {
            method.classList.remove('selected');
        });
        document.querySelector(`[data-payment="${paymentMethod}"]`).classList.add('selected');
        selectedPaymentMethod = paymentMethod;
    }
    // function openAddressModal() {
    //     window.location.href = "/addresses/add?redirect=checkout";
    // }
    async function editAddress(addressId, event) {
        event.stopPropagation();
        window.location.href = `/addresses/edit/${addressId}?redirect=checkout`;
    }
    async function deleteAddress(addressId, event) {
        event.stopPropagation();
        const result = await swal({
            title: "Delete Address?",
            text: "This address will be permanently deleted.",
            icon: "warning",
            buttons: {
                cancel: "Cancel",
                confirm: {
                    text: "Delete",
                    value: true,
                }
            },
            dangerMode: true,
        });
        if (result) {
            try {
                const response = await fetch(`/addresses/delete/${addressId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                if (data.success) {
                    swal("Deleted!", "Address has been deleted successfully.", "success")
                        .then(() => {
                            location.reload();
                        });
                } else {
                    swal("Error!", data.message, "error");
                }
            } catch (error) {
                console.error('Error:', error);
                swal("Error!", "Failed to delete address. Please try again.", "error");
            }
        }
    }
    async function placeOrder() {
        if (!selectedAddressId) {
            swal("Error!", "Please select a shipping address", "error");
            return;
        }
        if (!selectedPaymentMethod) {
            swal("Error!", "Please select a payment method", "error");
            return;
        }
        const btn = document.getElementById('placeOrderBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;
        try {
            const response = await fetch('/place-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    addressId: selectedAddressId,
                    paymentMethod: selectedPaymentMethod
                })
            });
            const data = await response.json();
            if (data.success) {
                if (selectedPaymentMethod === 'cod') {
                    swal("Order Placed!", `Your order has been placed successfully!\nOrder ID: ${data.displayOrderId}`, "success")
                        .then(() => {
                            window.location.href = `/order-success?orderId=${data.orderId}`;
                        });
                } else if (selectedPaymentMethod === 'online') {
                    const options = {
                        key: data.key,
                        amount: data.amount * 100,
                        currency: data.currency,
                        name: "Aranoz",
                        description: "Order Payment",
                        order_id: data.razorpayOrderId,
                        handler: async function (response) {
                            try {
                                const verifyResponse = await fetch('/checkout/verify-payment', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_signature: response.razorpay_signature,
                                        orderId: data.orderId
                                    })
                                });
                                const verifyData = await verifyResponse.json();
                                if (verifyData.success) {
                                    swal("Payment Successful!", "Your order has been placed successfully.", "success")
                                        .then(() => {
                                            window.location.href = `/order-success?orderId=${verifyData.orderId}`;
                                        });
                                } else {
                                    swal("Payment Verification Failed!", verifyData.message, "error")
                                        .then(() => {
                                            window.location.href = `/order-failure?orderId=${data.orderId}`;
                                        });
                                }
                            } catch (error) {
                                swal("Error!", "Payment verification failed. Please contact support.", "error")
                                    .then(() => {
                                        window.location.href = `/order-failure?orderId=${data.orderId}`;
                                    });
                            }
                        },
                        prefill: {
                            name: data.customerDetails.name,
                            email: data.customerDetails.email,
                            contact: data.customerDetails.contact
                        },
                        theme: {
                            color: "#ff3368"
                        },
                        modal: {
                            ondismiss: function () {
                                swal("Payment Cancelled!", "Order was placed but payment is pending.", "warning")
                                    .then(() => {
                                        window.location.href = `/order-failure?orderId=${data.orderId}`;
                                    });
                            }
                        }
                    };
                    const rzp = new Razorpay(options);
                    rzp.on('payment.failed', function (response) {
                        swal("Payment Failed!", response.error.description, "error")
                            .then(() => {
                                window.location.href = `/order-failure?orderId=${data.orderId}`;
                            });
                    });
                    rzp.open();
                }
            } else {
                swal("Error!", data.message, "error");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            swal("Error!", "Failed to place order. Please try again.", "error");
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }
    // COMMENTED OUT COUPON FUNCTIONS
    /*
    function openCouponModal() {
      swal({
        title: "Apply Coupon",
        content: {
          element: "input",
          attributes: {
            placeholder: "Enter coupon code",
            type: "text",
          },
        },
        buttons: {
          cancel: "Cancel",
          confirm: {
            text: "Apply",
            value: "apply",
          }
        }
      }).then((value) => {
        if (value) {
          applyCoupon(value);
        }
      });
    }
    async function applyCoupon(couponCode) {
      try {
        const response = await fetch('/applyCoupon', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ couponCode: couponCode })
        });
       
        const data = await response.json();
       
        if (data.success) {
          swal("Success!", `Discount of ₹${data.discount} applied!`, "success")
            .then(() => {
              location.reload();
            });
        } else {
          swal("Invalid!", data.message, "error");
        }
      } catch (error) {
        swal("Error!", "Failed to apply coupon", "error");
      }
    }
    */
</script>
</body>
</html>